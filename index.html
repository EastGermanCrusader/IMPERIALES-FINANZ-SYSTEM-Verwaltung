<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMPERIALES FINANZ SYSTEM</title>
  <link rel="icon" href="log_imp.png" type="image/png" />

  <!-- ========================= BLOCK: STYLES (CRT + UI) ========================= -->
  <style>
    /* === BLOCK: STYLES === */
  :root {
    --crt-bg: #000;
    --crt-color: #fff;
    --crt-font: 'Courier New', monospace;
  }

  body {
    background-color: var(--crt-bg);
    color: var(--crt-color);
    font-family: var(--crt-font);
    text-shadow: 0 0 1px #fff, 0 0 2px #fff;
  }

  .crt-effect {
    animation: flicker 1.5s infinite alternate;
  }

  @keyframes flicker {
    0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
      opacity: 1;
    }
    20%, 24%, 55% {
      opacity: 0.9;
    }
  }

  /* Wandernder Streifen */
  .scanline {
    position: fixed;
    top: -50%;
    left: 0;
    width: 100%;
    height: 50%;
    background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.05), transparent);
    animation: scan 6s linear infinite;
    pointer-events: none;
  }

  @keyframes scan {
    0% { top: -50%; }
    100% { top: 100%; }
  }

  /* Icons zwingend weiß */
  img.icon, .credit-symbol {
    filter: brightness(0) invert(1);
  }

  </style>
</head>
<body class="crt">
  <!-- CRT FX Overlays -->
  <div class="fx-layer fx-noise"></div>
  <div class="fx-sweep"></div>

  <!-- ========================= BLOCK: LOADER ========================= -->
  <div id="loader" class="loader">
    <div class="loader-inner">
      <img src="log_imp.png" alt="Imperiales Siegel" class="seal-img" />
      <div class="progress"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- ========================= BLOCK: SHELL ========================= -->
  <div class="wrap" style="opacity:0;transition:opacity .4s" id="rootWrap">
    <div class="topbar">
      <div class="brand"><img src="log_imp.png" class="logo" alt="Logo"/><div class="h1">IMPERIALES FINANZ SYSTEM</div></div>
      <div class="sp"></div>
      <button class="btn soft" id="btnLogout" style="display:none">Abmelden</button>
    </div>

    <!-- === BLOCK: LOGIN VIEW === -->
<div id="login-view">
  <h1>IMPERIALES FINANZ SYSTEM</h1>
  <form id="login-form">
    <label>BENUTZERNAME</label>
    <input type="text" id="username" required>
    <label>PASSWORT</label>
    <input type="password" id="password" required>
    <button type="submit">ANMELDEN</button>
  </form>
</div>


    <!-- ========================= BLOCK: APP ========================= -->
    <div id="app" style="display:none">
      <div class="row">
        <div class="col card pad">
          <div class="row" style="align-items:center">
            <div class="h1" id="roleBadge">Rolle</div><span id="userBadge"></span>
            <div class="sp"></div>
            <button class="btn ghost" id="btnExport">Export JSON</button>
            <label class="btn ghost" for="importFile">Import JSON</label>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>
          <div class="stats" style="margin-top:12px">
            <div class="stat"><h3>Gesamtbudget</h3><div class="v" id="statTotal"></div></div>
            <div class="stat"><h3>Zugewiesen</h3><div class="v" id="statAllocated"></div></div>
            <div class="stat"><h3>Verfügbar</h3><div class="v" id="statAvailable"></div></div>
            <div class="stat"><h3>Offene Anträge</h3><div class="v" id="statPending">0</div></div>
          </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="deps">Abteilungen</div>
        <div class="tab" data-tab="requests">Anträge</div>
        <div class="tab" data-tab="users">Nutzer</div>
        <div class="tab" data-tab="settings">Einstellungen</div>
      </div>

      <!-- ========================= BLOCK: TAB DASHBOARD ========================= -->
      <div id="tab-dashboard" class="card pad">
        <div class="row">
          <div class="col">
            <div id="topupAdmin" class="grid" style="display:none">
              <div>
                <label class="label">Betrag <img src="Credits.png" class="currency-icon" alt="Credits"/></label>
                <input class="input" id="topupAmount" placeholder="100000" type="number" min="0" step="0.01" />
              </div>
              <div>
                <label class="label">Verwendungszweck</label>
                <input class="input" id="topupNote" placeholder="" />
              </div>
              <div class="row"><button class="btn" id="btnTopup">Einzahlen</button></div>
            </div>
            <div id="topupInfo" class="grid" style="display:none">
              <div id="lastIncome" class="label"></div>
            </div>
          </div>
          <div class="col">
            <table id="auditTable">
              <thead><tr><th>Zeit</th><th>Aktion</th><th>Details</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB DEPARTMENTS ========================= -->
      <div id="tab-deps" class="card pad" style="display:none">
        <div class="row" style="align-items:end">
          <div class="col">
            <label class="label">Abteilungsname</label>
            <input class="input" id="depName" placeholder="" />
          </div>
          <div class="col" style="max-width:200px">
            <label class="label">Code</label>
            <input class="input" id="depCode" placeholder="IMN" />
          </div>
          <div class="col" style="max-width:220px">
            <button class="btn" id="btnAddDep">Anlegen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="depTable">
            <thead><tr><th>Code</th><th>Abteilung</th><th>Budget</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB REQUESTS ========================= -->
      <div id="tab-requests" class="card pad" style="display:none">
        <div class="row" style="align_items:end">
          <div class="col">
            <label class="label">Titel</label>
            <input class="input" id="reqTitle" placeholder="" />
          </div>
          <div class="col">
            <label class="label">Abteilung</label>
            <select id="reqDept" class="input"></select>
          </div>
          <div class="col" style="max-width:200px">
            <label class="label">Betrag <img src="Credits.png" class="currency-icon" alt="Credits"/></label>
            <input class="input" id="reqAmount" type="number" min="0" step="0.01" placeholder="50000" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="label">Beschreibung</label>
            <textarea class="input" id="reqDesc" rows="2" placeholder=""></textarea>
          </div>
          <div class="col" style="max-width:220px;display:flex;align-items:flex-end">
            <button class="btn" id="btnSubmitReq">Antrag erstellen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="reqTable">
            <thead><tr><th>Zeit</th><th>Titel</th><th>Abteilung</th><th>Betrag</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB USERS (ADMIN) ========================= -->
      <div id="tab-users" class="card pad" style="display:none">
        <div class="row" style="align-items:end">
          <div class="col">
            <label class="label">Benutzername</label>
            <input class="input" id="userName" placeholder="z.B. minister01" />
          </div>
          <div class="col" style="max-width:220px">
            <label class="label">Rolle</label>
            <select id="userRole" class="input">
              <option>Administrator</option>
              <option>Finanzminister</option>
              <option>Prüfer</option>
              <option>Gouverneur</option>
              <option>Schreiber</option>
            </select>
          </div>
          <div class="col">
            <label class="label">Passwort</label>
            <input class="input" id="userPass" type="password" placeholder="••••••" />
          </div>
          <div class="col" style="max-width:220px">
            <button class="btn" id="btnAddUser">Nutzer anlegen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="userTable">
            <thead><tr><th>Benutzername</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB SETTINGS ========================= -->
      <div id="tab-settings" class="card pad" style="display:none">
        <div class="row">
          <div class="col" style="max-width:360px">
            <label class="label">Neues Passwort</label>
            <input class="input" id="newPass" type="password" placeholder="••••••" />
            <div class="row" style="margin-top:8px"><button class="btn" id="btnChangePass">Passwort ändern</button></div>
          </div>
          <div class="col">
            <div class="row" style="margin-top:12px;gap:8px">
              <button class="btn soft" id="btnReset">Alles zurücksetzen</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ========================= BLOCK: SCRIPT (MODULED) ========================= -->
  <script>
  // ===== BLOCK: CONSTANTS & HELPERS =====
  const LS_KEY = 'imperial_finance_blocks_v1';
  const byId = id => document.getElementById(id);
  const now = () => new Date().toISOString();
  const numDE = n => Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const curHTML = n => `<span class="cur"><img src="Credits.png" class="currency-icon" alt="Credits"/> ${numDE(n)}</span>`;

  // === BLOCK: STATE & AUTH ===
const state = {
  user: null,
  roles: {
    admin: { canTopUp: true, canAssign: true },
    minister: { canTopUp: false, canAssign: true }
  },
  budget: 0,
  assigned: 0,
  log: []
};

const users = [
  { username: "Admin01", password: "!#Imperium#!", role: "admin" },
  // Finanzminister-Beispiele können hier hinzugefügt werden
];

function login(username, password) {
  const user = users.find(u => u.username === username && u.password === password);
  if (user) {
    state.user = user;
    addLog(`${user.username} – login`, "ok");
    showApp();
  } else {
    alert("Ungültige Zugangsdaten");
  }
}

function logout() {
  if (state.user) addLog(`${state.user.username} – logout`, "bye");
  state.user = null;
  showLogin();
}


  // ===== BLOCK: COMPUTE =====
  const Compute = (()=>{
    const totalAllocated = ()=> State.get().departments.reduce((a,d)=>a+(d.budget||0),0);
    const available = ()=> (State.get().treasury.fund||0) - totalAllocated();
    const pendingCount = ()=> State.get().requests.filter(r=>r.status==='pending').length;
    return { totalAllocated, available, pendingCount };
  })();

  // ===== BLOCK: UI RENDER =====
  const UI = (()=>{
    const showLogin = ()=>{ byId('app').style.display='none'; byId('viewLogin').style.display='block'; byId('btnLogout').style.display='none'; };
    const showApp = ()=>{ byId('viewLogin').style.display='none'; byId('app').style.display='block'; byId('btnLogout').style.display='inline-block'; };

    function header(){
      const s = State.get(); if(!s.session.user) return;
      byId('roleBadge').textContent = s.session.user.role;
      byId('userBadge').textContent = ' '+s.session.user.username;
      byId('statTotal').innerHTML = curHTML(s.treasury.fund);
      byId('statAllocated').innerHTML = curHTML(Compute.totalAllocated());
      byId('statAvailable').innerHTML = curHTML(Compute.available());
      byId('statPending').textContent = String(Compute.pendingCount());
    }
    function audit(){
      const tbody = byId('auditTable').querySelector('tbody'); tbody.innerHTML='';
      State.get().audit.slice(0,10).forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(e.ts).toLocaleString('de-DE')}</td><td>${e.actor} – ${e.action}</td><td>${e.details||''}</td>`; tbody.appendChild(tr); });
    }
    function topup(){
      const isA = Auth.isAdmin();
      byId('topupAdmin').style.display = isA? 'grid':'none';
      byId('topupInfo').style.display = isA? 'none':'grid';
      if(!isA){ const last = State.get().treasury.notes[0]; byId('lastIncome').innerHTML = last? `Letzte Einnahme: ${curHTML(last.amount)} – ${last.note||''}` : ''; }
    }
    function deps(){
      const s = State.get(); const body = byId('depTable').querySelector('tbody'); body.innerHTML='';
      s.departments.forEach(dep=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><b>${dep.code}</b></td><td>${dep.name}</td><td>${curHTML(dep.budget)}</td><td><div class="row" style="gap:6px"><button class="btn soft" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.allocPrompt('${dep.id}')">Zuweisen</button><button class="btn ghost" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.editDepPrompt('${dep.id}')">Bearbeiten</button><button class="btn bad" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.deleteDep('${dep.id}')">Löschen</button></div></td>`; body.appendChild(tr); });
      const sel = byId('reqDept'); sel.innerHTML=''; s.departments.forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=`${d.name} (${d.code})`; sel.appendChild(o); });
    }
    function requests(){
      const s = State.get(); const body = byId('reqTable').querySelector('tbody'); body.innerHTML='';
      s.requests.forEach(r=>{ const dep=s.departments.find(d=>d.id===r.deptId); const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(r.ts).toLocaleString('de-DE')}</td><td>${r.title}</td><td>${dep?dep.name:''}</td><td>${curHTML(r.amount)}</td><td>${r.status}</td><td><div class="row" style="gap:6px"><button class="btn soft" ${(Auth.isMinister()||Auth.isAdmin())&&r.status==='pending'?'':'disabled'} onclick="Actions.approveReq('${r.id}')">OK</button><button class="btn ghost" ${(Auth.isMinister()||Auth.isAdmin())&&r.status==='pending'?'':'disabled'} onclick="Actions.rejectReq('${r.id}')">X</button><button class="btn bad" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.deleteReq('${r.id}')">DEL</button></div></td>`; body.appendChild(tr); });
    }
    function users(){
      const body = byId('userTable')?.querySelector('tbody'); if(!body) return; body.innerHTML='';
      State.get().users.forEach(u=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.username}</td><td>${u.role}</td><td>${u.active?'<span>aktiv</span>':'<span>deaktiviert</span>'}</td><td><div class="row" style="gap:6px"><button class="btn ghost" ${!Auth.isAdmin()?'disabled':''} onclick="Actions.editUserPrompt('${u.username}')">Edit</button><button class="btn soft" ${!Auth.isAdmin()?'disabled':''} onclick="Actions.toggleUser('${u.username}')">${u.active?'Off':'On'}</button><button class="btn bad" ${!Auth.isAdmin()||u.username==='Admin01'?'disabled':''} onclick="Actions.deleteUser('${u.username}')">DEL</button></div></td>`; body.appendChild(tr); });
      document.querySelector('[data-tab="users"]').style.display = Auth.isAdmin()? 'inline-block':'none';
    }
    function renderAll(){ if(!State.get().session.user){ showLogin(); return; } showApp(); header(); topup(); audit(); deps(); requests(); users(); }
    return { showLogin, showApp, renderAll };
  })();

  // === BLOCK: UI RENDER: DASHBOARD ===
function renderDashboard() {
  document.getElementById("budget").innerText = formatCredits(state.budget);
  document.getElementById("assigned").innerText = formatCredits(state.assigned);
  document.getElementById("available").innerText = formatCredits(state.budget - state.assigned);
  renderLog();
}

function formatCredits(value) {
  return `\uE001 ${value.toLocaleString()}`; // Währungssymbol über Icon-Font oder Bild
}


    // Exposed inline handlers (kept minimal)
    function deleteDep(id){ if(!(Auth.isMinister()||Auth.isAdmin())) return; const s=State.get(); const dep=s.departments.find(d=>d.id===id); if(dep?.budget>0) return alert('Budget zuerst auf 0'); s.departments=s.departments.filter(d=>d.id!==id); State.log(s.session.user.username,'dep_delete',dep?dep.code:''); State.save(); UI.renderAll(); }
    function editDepPrompt(id){ if(!(Auth.isMinister()||Auth.isAdmin())) return; const s=State.get(); const dep=s.departments.find(d=>d.id===id); const name=prompt('Neuer Name',dep.name); if(name){ dep.name=name.trim(); State.save(); UI.renderAll(); State.log(s.session.user.username,'dep_rename',dep.code+'->'+name); } }
    function allocPrompt(id){ if(!(Auth.isMinister()||Auth.isAdmin())) return; const s=State.get(); const dep=s.departments.find(d=>d.id===id); const amtStr=prompt('Betrag (Credits), verfügbar: '+numDE(Compute.available()), '10000'); if(!amtStr) return; const amt=parseFloat(amtStr.replace(',','.')); if(!(amt>0)) return; if(amt>Compute.available()) return alert('Zu wenig Fond'); dep.budget+=amt; State.log(s.session.user.username,'alloc',dep.code+' +'+amt); State.save(); UI.renderAll(); }
    function approveReq(id){ if(!(Auth.isMinister()||Auth.isAdmin())) return; const s=State.get(); const r=s.requests.find(x=>x.id===id); if(!r||r.status!=='pending') return; if(r.amount>Compute.available()) return alert('Zu wenig Fond'); const dep=s.departments.find(d=>d.id===r.deptId); dep.budget+=r.amount; r.status='approved'; r.decidedBy=s.session.user.username; r.decidedAt=now(); State.log(s.session.user.username,'req_approve',r.title+' '+r.amount); State.save(); UI.renderAll(); }
    function rejectReq(id){ if(!(Auth.isMinister()||Auth.isAdmin())) return; const s=State.get(); const r=s.requests.find(x=>x.id===id); if(!r||r.status!=='pending') return; r.status='rejected'; r.decidedBy=s.session.user.username; r.decidedAt=now(); State.log(s.session.user.username,'req_reject',r.title); State.save(); UI.renderAll(); }
    function deleteReq(id){ if(!(Auth.isMinister()||Auth.isAdmin())) return; const s=State.get(); s.requests=s.requests.filter(x=>x.id!==id); State.log(s.session.user.username,'req_delete',id); State.save(); UI.renderAll(); }
    function editUserPrompt(username){ if(!Auth.isAdmin()) return; const s=State.get(); const u=s.users.find(x=>x.username===username); const newRole=prompt('Rolle',u.role); if(newRole){ u.role=newRole; } const newPass=prompt('Neues Passwort (leer=skip)',''); if(newPass){ u.password=newPass; } State.save(); UI.renderAll(); State.log(s.session.user.username,'user_edit',username); }
    function toggleUser(username){ if(!Auth.isAdmin()) return; const s=State.get(); const u=s.users.find(x=>x.username===username); if(!u) return; u.active=!u.active; State.save(); UI.renderAll(); State.log(s.session.user.username,'user_toggle',username+' -> '+(u.active?'aktiv':'deaktiviert')); }
    function deleteUser(username){ if(!Auth.isAdmin()) return; if(username==='Admin01') return alert('Admin01 geschützt'); const s=State.get(); s.users=s.users.filter(u=>u.username!==username); State.save(); UI.renderAll(); State.log(s.session.user.username,'user_delete',username); }

    return { bind, deleteDep, editDepPrompt, allocPrompt, approveReq, rejectReq, deleteReq, editUserPrompt, toggleUser, deleteUser };
  

  // ===== BLOCK: BOOT =====
  (function Boot(){
    // loader fade
    const loader = byId('loader'); const wrap = byId('rootWrap');
    State.load();
    setTimeout(()=>{ loader.style.display='none'; wrap.style.opacity=1; Actions.bind(); if(State.get().session.user){ UI.showApp(); } else { UI.showLogin(); } UI.renderAll(); }, 900);
  })();
  </script>
</body>
</html>