<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Imperiales Finanz System</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== GLOBAL STYLES ===== */
body {
  margin: 0;
  font-family: 'Orbitron', sans-serif;
  background: black;
  color: white;
  overflow-x: hidden;
}
h1,h2,h3 { margin: 0; }
button {
  font-family: inherit;
  background: none;
  border: 1px solid white;
  color: white;
  padding: 6px 10px;
  cursor: pointer;
}
button:disabled { opacity: 0.4; cursor: not-allowed; }
input, select {
  background: black;
  border: 1px solid white;
  color: white;
  padding: 4px;
  font-family: inherit;
}
table {
  width: 100%;
  border-collapse: collapse;
}
td,th {
  border: 1px solid white;
  padding: 4px;
}
th {
  background: rgba(255,255,255,0.1);
}
nav {
  background: rgba(255,255,255,0.1);
  padding: 5px;
  display: flex;
  gap: 10px;
}
nav button { flex: 1; }

/* CRT SCANLINES & FLICKER */
body::after {
  content: "";
  pointer-events: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.05),
    rgba(255,255,255,0.05) 1px,
    transparent 2px,
    transparent 4px
  );
  animation: flicker 0.15s infinite;
}
@keyframes flicker {
  0% { opacity: 0.9; }
  50% { opacity: 1; }
  100% { opacity: 0.85; }
}

/* LOADER */
#loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: black;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 1000;
}
#loader p {
  animation: blink 1s infinite;
}
@keyframes blink {
  50% { opacity: 0; }
}
.hidden { display: none; }
</style>
</head>
<body>

<!-- ===== LOADER ===== -->
<div id="loader">
  <img src="credits.png" alt="Credits" style="width:60px;">
  <p>Lade Imperiales Finanz System...</p>
</div>

<!-- ===== LOGIN ===== -->
<div id="loginView" class="">
  <h1>Imperiales Finanz System</h1>
  <p>Login</p>
  <input id="loginUser" placeholder="Benutzername"><br><br>
  <input id="loginPass" type="password" placeholder="Passwort"><br><br>
  <button onclick="login()">Anmelden</button>
</div>

<!-- ===== APP ===== -->
<div id="appView" class="hidden">
  <nav id="navButtons"></nav>
  <div id="content"></div>
</div>

<script>
/* ===== STATE ===== */
let state = {
  users: [
    {username:"Admin01", password:"Admin1234", role:"admin", active:true}
  ],
  treasury: 0,
  departments: [],
  requests: [],
  logs: []
};
let currentUser = null;

/* ===== UTILS ===== */
function logAction(action, details) {
  state.logs.unshift({
    ts: Date.now(),
    actor: currentUser.username,
    action, details
  });
}
function curHTML(amount) {
  return `<img src="credits.png" style="width:14px;vertical-align:middle;"> ${amount}`;
}

/* ===== LOGIN ===== */
function login() {
  let u = document.getElementById("loginUser").value.trim();
  let p = document.getElementById("loginPass").value.trim();
  let found = state.users.find(x=>x.username===u && x.password===p && x.active);
  if(!found){ alert("Falsche Anmeldedaten"); return; }
  currentUser = found;
  document.getElementById("loginView").classList.add("hidden");
  document.getElementById("appView").classList.remove("hidden");
  renderNav();
  renderDashboard();
}

/* ===== NAVIGATION ===== */
function renderNav(){
  let nav = document.getElementById("navButtons");
  nav.innerHTML = "";
  if(currentUser.role==="admin"){
    nav.innerHTML += `<button onclick="renderDashboard()">Dashboard</button>
      <button onclick="renderDepartments()">Abteilungen</button>
      <button onclick="renderRequests()">Anträge</button>
      <button onclick="renderUsers()">Benutzer</button>
      <button onclick="renderLogs()">Logs</button>
      <button onclick="resetAll()">Alles zurück</button>`;
  }
  if(currentUser.role==="governor" || currentUser.role==="minister"){
    nav.innerHTML += `<button onclick="renderDashboard()">Dashboard</button>
      <button onclick="renderDepartments()">Abteilungen</button>
      <button onclick="renderRequests()">Anträge</button>`;
  }
  if(currentUser.role==="auditor"){
    nav.innerHTML += `<button onclick="renderLogs()">Logs</button>`;
  }
  nav.innerHTML += `<button onclick="logout()">Logout</button>`;
}

/* ===== VIEWS ===== */
function renderDashboard(){
  let html = `<h2>Dashboard</h2>
  <p>Gesamtbudget: ${curHTML(state.treasury)}</p>
  <canvas id="deptChart" height="100"></canvas>
  <canvas id="fundChart" height="100"></canvas>`;
  document.getElementById("content").innerHTML = html;

  // Charts
  setTimeout(()=>{
    let ctx1 = document.getElementById('deptChart').getContext('2d');
    new Chart(ctx1, {
      type: 'pie',
      data: {
        labels: state.departments.map(d=>d.name),
        datasets: [{
          data: state.departments.map(d=>d.budget),
          backgroundColor: ['#0ff','#0f0','#ff0','#f0f']
        }]
      }
    });
    let ctx2 = document.getElementById('fundChart').getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: state.logs.filter(l=>l.action.includes("Einnahme")).map(l=>new Date(l.ts).toLocaleDateString()),
        datasets: [{
          label: 'Einnahmen',
          data: state.logs.filter(l=>l.action.includes("Einnahme")).map(l=>parseInt(l.details||0)),
          backgroundColor: '#0f0'
        }]
      }
    });
  },100);
}
function renderDepartments(){
  let html = `<h2>Abteilungen</h2>
  <table><tr><th>Kürzel</th><th>Name</th><th>Budget</th><th>Aktionen</th></tr>`;
  state.departments.forEach((d,i)=>{
    html += `<tr><td>${d.code}</td><td>${d.name}</td><td>${curHTML(d.budget)}</td><td>
    <button onclick="allocDept(${i})">Zuweisen</button>
    <button onclick="deleteDept(${i})">Löschen</button>
    </td></tr>`;
  });
  html += `</table>
  <h3>Neue Abteilung</h3>
  <input id="depCode" placeholder="Kürzel">
  <input id="depName" placeholder="Name">
  <button onclick="addDept()">Hinzufügen</button>`;
  document.getElementById("content").innerHTML = html;
}
function renderRequests(){
  let html = `<h2>Anträge</h2>
  <table><tr><th>Datum</th><th>Titel</th><th>Abteilung</th><th>Betrag</th></tr>`;
  state.requests.forEach(r=>{
    html += `<tr><td>${new Date(r.ts).toLocaleString()}</td><td>${r.title}</td><td>${r.dept}</td><td>${curHTML(r.amount)}</td></tr>`;
  });
  html += `</table>`;
  document.getElementById("content").innerHTML = html;
}
function renderUsers(){
  let html = `<h2>Benutzer</h2>
  <table><tr><th>Name</th><th>Rolle</th><th>Aktionen</th></tr>`;
  state.users.forEach((u,i)=>{
    html += `<tr><td>${u.username}</td><td>${u.role}</td><td>
    <button onclick="deleteUser(${i})">Löschen</button></td></tr>`;
  });
  html += `</table>
  <h3>Neuer Benutzer</h3>
  <input id="newUser" placeholder="Name">
  <input id="newPass" placeholder="Passwort">
  <select id="newRole">
    <option value="governor">Governor</option>
    <option value="minister">Finanzminister</option>
    <option value="auditor">Prüfer</option>
  </select>
  <button onclick="addUser()">Hinzufügen</button>`;
  document.getElementById("content").innerHTML = html;
}
function renderLogs(){
  let html = `<h2>Logs</h2>
  <table><tr><th>Datum</th><th>Aktion</th><th>Details</th></tr>`;
  state.logs.forEach(l=>{
    html += `<tr><td>${new Date(l.ts).toLocaleString()}</td><td>${l.actor} - ${l.action}</td><td>${l.details}</td></tr>`;
  });
  html += `</table>`;
  document.getElementById("content").innerHTML = html;
}

/* ===== ACTIONS ===== */
function addDept(){
  let code = document.getElementById("depCode").value;
  let name = document.getElementById("depName").value;
  state.departments.push({code, name, budget:0});
  logAction("Abteilung erstellt", name);
  renderDepartments();
}
function deleteDept(i){
  logAction("Abteilung gelöscht", state.departments[i].name);
  state.departments.splice(i,1);
  renderDepartments();
}
function allocDept(i){
  let amount = parseInt(prompt("Betrag zuweisen:"));
  if(isNaN(amount)) return;
  state.departments[i].budget += amount;
  state.treasury -= amount;
  logAction("Budget zugewiesen", amount);
  renderDepartments();
}
function addUser(){
  let name = document.getElementById("newUser").value;
  let pass = document.getElementById("newPass").value;
  let role = document.getElementById("newRole").value;
  state.users.push({username:name,password:pass,role,active:true});
  logAction("Benutzer erstellt", name);
  renderUsers();
}
function deleteUser(i){
  logAction("Benutzer gelöscht", state.users[i].username);
  state.users.splice(i,1);
  renderUsers();
}
function resetAll(){
  if(!confirm("Alle Daten zurücksetzen?")) return;
  state = { users:[{username:"Admin01",password:"Admin1234",role:"admin",active:true}], treasury:0, departments:[], requests:[], logs:[] };
  logAction("System zurückgesetzt","");
  renderDashboard();
}
function logout(){
  currentUser = null;
  document.getElementById("appView").classList.add("hidden");
  document.getElementById("loginView").classList.remove("hidden");
}

/* ===== LOADER HIDE ===== */
window.onload = ()=>{
  setTimeout(()=>{ document.getElementById("loader").classList.add("hidden"); },1500);
};
</script>
</body>
</html>
