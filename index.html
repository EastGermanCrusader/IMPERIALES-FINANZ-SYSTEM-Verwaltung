<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMPERIALES FINANZ SYSTEM</title>
  <link rel="icon" href="log_imp.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

  <!-- ========================= BLOCK: STYLES (CRT + UI) ========================= -->
  <style>
    :root{ --bg:#000; --panel:#0d0d0d; --ink:#e6e6e6; --muted:#9a9a9a; --line:#2a2a2a; --ring:#3a3a3a; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 'Orbitron', system-ui, sans-serif; position:relative}

    /* CRT Scanlines */
    body::after{content:"";position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(to bottom, rgba(255,255,255,.035), rgba(255,255,255,.035) 1px, transparent 1px, transparent 3px);mix-blend-mode:overlay}
    /* CRT Static + Sweep */
    .fx-layer{position:fixed;inset:0;pointer-events:none;z-index:9990}
    .fx-noise{background:repeating-linear-gradient(0deg, rgba(255,255,255,.022) 0 1px, transparent 1px 2px), repeating-linear-gradient(90deg, rgba(255,255,255,.018) 0 1px, transparent 1px 3px); animation:noiseFlash 600ms steps(2,end) infinite}
    @keyframes noiseFlash{50%{opacity:.8}0%,100%{opacity:.95}}
    .fx-sweep{background:linear-gradient(to bottom, transparent 0%, rgba(255,255,255,.08) 50%, transparent 100%); height:15%; width:100%; position:fixed; left:0; top:-20%; mix-blend-mode:screen; z-index:9991; animation:sweep 6s linear infinite}
    @keyframes sweep{0%{transform:translateY(-30vh)} 100%{transform:translateY(130vh)}}
    @keyframes flicker{0%,100%{opacity:.98} 50%{opacity:.94}}
    .crt{animation:flicker 3s infinite}

    /* UI Shell */
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .brand{display:flex;align-items:center;gap:.6rem}
    .logo{width:20px;height:20px;filter:brightness(0) invert(1) contrast(1.05);opacity:.95}
    .h1{font-size:20px;font-weight:800;letter-spacing:.06em;text-shadow:0 0 6px rgba(255,255,255,.25)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 20px rgba(0,0,0,.5)}
    .pad{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .btn{appearance:none;border:1px solid var(--ink);padding:8px 12px;border-radius:8px;background:transparent;color:var(--ink);font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.08em}
    .btn:hover{background:#111}
    .btn.bad{border-color:#fff;background:#111}
    .btn.soft{border-color:#777;color:#ddd}
    .btn.ghost{border-color:#555;color:#ccc}
    .input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--ring);background:#0a0a0a;color:var(--ink);outline:none}
    .input:focus, select:focus, textarea:focus{box-shadow:0 0 0 2px rgba(255,255,255,.08)}
    .label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em}
    .grid{display:grid;gap:12px}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.stats{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .stat{padding:14px 16px;border-radius:10px;background:#0a0a0a;border:1px solid var(--line)}
    .stat h3{margin:0 0 4px 0;font:700 12px/1.2 ui-monospace;letter-spacing:.08em;color:#cfcfcf}
    .stat .v{font-size:20px;font-weight:800;display:flex;align-items:center;gap:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:#c8c8c8;font-weight:700;text-transform:uppercase;letter-spacing:.08em}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid var(--line);cursor:pointer}
    .tab.active{background:#101010;border-color:#777}
    .topbar{display:flex;align-items:center;gap:12px;padding:10px 0}
    .sp{flex:1}

    /* Currency + icons forced white */
    .currency-icon{width:16px;height:16px;vertical-align:-3px;filter:brightness(0) invert(1) contrast(1.05);opacity:.95}
    .cur{display:inline-flex;align-items:center;gap:6px}

    /* Loader */
    .loader{position:fixed;inset:0;background:#000;display:grid;place-items:center;z-index:10000}
    .loader-inner{display:grid;gap:14px;place-items:center;color:#e8e8ea}
    .seal-img{width:92px;height:92px;filter:brightness(0) invert(1) contrast(1.05);opacity:.98}
    .progress{display:flex;gap:6px}
    .dot{width:8px;height:8px;border-radius:50%;background:#fff;opacity:.25}
    .dot:nth-child(1){animation:d 1.2s infinite}
    .dot:nth-child(2){animation:d 1.2s .2s infinite}
    .dot:nth-child(3){animation:d 1.2s .4s infinite}
    @keyframes d{0%,100%{opacity:.25}50%{opacity:1}}
  </style>
</head>
<body class="crt">
  <!-- CRT FX Overlays -->
  <div class="fx-layer fx-noise"></div>
  <div class="fx-sweep"></div>

  <!-- ========================= BLOCK: LOADER ========================= -->
  <div id="loader" class="loader">
    <div class="loader-inner">
      <img src="log_imp.png" alt="Imperiales Siegel" class="seal-img" />
      <div class="progress"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- ========================= BLOCK: SHELL ========================= -->
  <div class="wrap" style="opacity:0;transition:opacity .4s" id="rootWrap">
    <div class="topbar">
      <div class="brand"><img src="log_imp.png" class="logo" alt="Logo"/><div class="h1">IMPERIALES FINANZ SYSTEM</div></div>
      <div class="sp"></div>
      <button class="btn soft" id="btnLogout" style="display:none">Abmelden</button>
    </div>

    <!-- ========================= BLOCK: LOGIN VIEW ========================= -->
    <div id="viewLogin" class="card pad" style="max-width:520px;margin:40px auto 0 auto;display:none">
      <div class="grid">
        <div>
          <label class="label">Benutzername</label>
          <input class="input" id="loginUser" />
        </div>
        <div>
          <label class="label">Passwort</label>
          <input class="input" id="loginPass" type="password" />
        </div>
        <div class="row" style="align-items:center;gap:8px">
          <button class="btn" id="btnLogin">Anmelden</button>
        </div>
      </div>
    </div>

    <!-- ========================= BLOCK: APP ========================= -->
    <div id="app" style="display:none">
      <div class="row">
        <div class="col card pad">
          <div class="row" style="align-items:center">
            <div class="h1" id="roleBadge">Rolle</div><span id="userBadge"></span>
            <div class="sp"></div>
            
            
          </div>
          <div class="stats" style="margin-top:12px">
            <div class="stat"><h3>Gesamtbudget</h3><div class="v" id="statTotal"></div></div>
            <div class="stat"><h3>Zugewiesen</h3><div class="v" id="statAllocated"></div></div>
            <div class="stat"><h3>Verfügbar</h3><div class="v" id="statAvailable"></div></div>
            <div class="stat"><h3>Offene Anträge</h3><div class="v" id="statPending">0</div></div>
          </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="deps">Abteilungen</div>
        <div class="tab" data-tab="requests">Anträge</div>
        <div class="tab" data-tab="users">Nutzer</div>
        <div class="tab" data-tab="settings">Einstellungen</div>
      </div>

      <!-- ========================= BLOCK: TAB DASHBOARD ========================= -->
      <div id="tab-dashboard" class="card pad">
        <div class="row">
          <div class="col">
            <div id="topupAdmin" class="grid" style="display:none">
              <div>
                <label class="label">Betrag <img src="Credits.png" class="currency-icon" alt="Credits"/></label>
                <input class="input" id="topupAmount" placeholder="100000" type="number" min="0" step="0.01" />
              </div>
              <div>
                <label class="label">Verwendungszweck</label>
                <input class="input" id="topupNote" placeholder="" />
              </div>
              <div class="row"><button class="btn" id="btnTopup">Einzahlen</button></div>
            </div>
            <div id="topupInfo" class="grid" style="display:none">
              <div id="lastIncome" class="label"></div>
            </div>
          </div>
          <div class="col">
            <table id="auditTable">
              <thead><tr><th>Zeit</th><th>Aktion</th><th>Details</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB DEPARTMENTS ========================= -->
      <div id="tab-deps" class="card pad" style="display:none">
        <div class="row" style="align-items:end">
          <div class="col">
            <label class="label">Abteilungsname</label>
            <input class="input" id="depName" placeholder="" />
          </div>
          <div class="col" style="max-width:200px">
            <label class="label">Kürzel</label>
            <input class="input" id="depCode" placeholder="IMN" />
          </div>
          <div class="col" style="max-width:220px">
            <button class="btn" id="btnAddDep">Anlegen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="depTable">
            <thead><tr><th>Kürzel</th><th>Abteilung</th><th>Budget</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB REQUESTS ========================= -->
      <div id="tab-requests" class="card pad" style="display:none">
        <div class="row" style="align_items:end">
          <div class="col">
            <label class="label">Titel</label>
            <input class="input" id="reqTitle" placeholder="" />
          </div>
          <div class="col">
            <label class="label">Abteilung</label>
            <select id="reqDept" class="input"></select>
          </div>
          <div class="col" style="max-width:200px">
            <label class="label">Betrag <img src="Credits.png" class="currency-icon" alt="Credits"/></label>
            <input class="input" id="reqAmount" type="number" min="0" step="0.01" placeholder="50000" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="label">Beschreibung</label>
            <textarea class="input" id="reqDesc" rows="2" placeholder=""></textarea>
          </div>
          <div class="col" style="max-width:220px;display:flex;align-items:flex-end">
            <button class="btn" id="btnSubmitReq">Antrag erstellen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="reqTable">
            <thead><tr><th>Zeit</th><th>Titel</th><th>Abteilung</th><th>Betrag</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB USERS (ADMIN) ========================= -->
      <div id="tab-users" class="card pad" style="display:none">
        <div class="row" style="align-items:end">
          <div class="col">
            <label class="label">Benutzername</label>
            <input class="input" id="userName" placeholder="z.B. minister01" />
          </div>
          <div class="col" style="max-width:220px">
            <label class="label">Rolle</label>
            <select id="userRole" class="input">
              <option>Administrator</option>
              <option>Finanzminister</option>
              <option>Prüfer</option>
              <option>Gouverneur</option>
              <option>Schreiber</option>
            </select>
          </div>
          <div class="col">
            <label class="label">Passwort</label>
            <input class="input" id="userPass" type="password" placeholder="••••••" />
          </div>
          <div class="col" style="max-width:220px">
            <button class="btn" id="btnAddUser">Nutzer anlegen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="userTable">
            <thead><tr><th>Benutzername</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB SETTINGS ========================= -->
      <div id="tab-settings" class="card pad" style="display:none">
        <div class="row">
          <div class="col" style="max-width:360px">
            <label class="label">Neues Passwort</label>
            <input class="input" id="newPass" type="password" placeholder="••••••" />
            <div class="row" style="margin-top:8px"><button class="btn" id="btnChangePass">Passwort ändern</button></div>
          </div>
          <div class="col">
            <div class="row" style="margin-top:12px;gap:8px">
              <button class="btn soft" id="btnReset">Alles zurücksetzen</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ========================= BLOCK: SCRIPT (MODULED) ========================= -->
  <script>
  // ===== BLOCK: CONSTANTS & HELPERS =====
  const LS_KEY = 'imperial_finance_blocks_v2';
  const byId = id => document.getElementById(id);
  const now = () => new Date().toISOString();
  const numDE = n => Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const curHTML = n => `<span class="cur"><img src="Credits.png" class="currency-icon" alt="Credits"/> ${numDE(n)}</span>`;

  // ===== BLOCK: STATE =====
  const State = (()=>{
    const initial = ()=>({
      users:[{username:'Admin01', role:'Administrator', password:'Admin1234', active:true}],
      session:{user:null},
      treasury:{fund:0, notes:[]},
      departments:[],
      requests:[],
      audit:[{ts:now(), actor:'system', action:'init', details:'Fond=0, nur Admin'}]
    });
    let s = null;
    const load = ()=>{ const raw = localStorage.getItem(LS_KEY); s = raw? JSON.parse(raw): initial(); };
    const save = ()=> localStorage.setItem(LS_KEY, JSON.stringify(s));
    const log = (actor,action,details)=>{ s.audit.unshift({ts:now(),actor,action,details}); if(s.audit.length>2000) s.audit.pop(); };
    return { get:()=>s, set:v=>{s=v;}, load, save, log, initial };
  })();

  // ===== BLOCK: AUTH =====
  const Auth = (()=>{
    const isAdmin = ()=> State.get().session.user?.role==='Administrator';
    const isMinister = ()=> State.get().session.user?.role==='Finanzminister';
    const login = (u,p)=>{
      const s = State.get();
      const f = s.users.find(x=>x.active && x.username===u && x.password===p);
      if(!f) return false;
      s.session.user = {username:f.username, role:f.role};
      State.log(u,'login','ok'); State.save(); UI.renderAll();
      return true;
    };
    const logout = ()=>{ const s=State.get(); if(s.session.user) State.log(s.session.user.username,'logout','bye'); s.session.user=null; State.save(); UI.showLogin(); };
    return { isAdmin, isMinister, login, logout };
  })();

  // ===== BLOCK: COMPUTE =====
  const Compute = (()=>{
    const totalAllocated = ()=> State.get().departments.reduce((a,d)=>a+(d.budget||0),0);
    const available = ()=> (State.get().treasury.fund||0) - totalAllocated();
    const pendingCount = ()=> State.get().requests.filter(r=>r.status==='pending').length;
    return { totalAllocated, available, pendingCount };
  })();

  // ===== BLOCK: UI RENDER =====
const UI = (() => {
  const showLogin = () => {
    byId('app').style.display = 'none';
    byId('viewLogin').style.display = 'block';
    byId('btnLogout').style.display = 'none';
  };
  const showApp = () => {
    byId('viewLogin').style.display = 'none';
    byId('app').style.display = 'block';
    byId('btnLogout').style.display = 'inline-block';
  };

  function header() {
    const s = State.get();
    if (!s.session.user) return;
    byId('roleBadge').textContent = s.session.user.role;
    byId('userBadge').textContent = ' ' + s.session.user.username;
    byId('statTotal').innerHTML = curHTML(s.treasury.fund);
    byId('statAllocated').innerHTML = curHTML(Compute.totalAllocated());
    byId('statAvailable').innerHTML = curHTML(Compute.available());
    byId('statPending').textContent = String(Compute.pendingCount());
  }

  function audit() {
    const tbody = byId('auditTable').querySelector('tbody');
    tbody.innerHTML = '';
    State.get().audit.slice(0, 10).forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(e.ts).toLocaleString('de-DE')}</td><td>${e.actor} – ${e.action}</td><td>${e.details || ''}</td>`;
      tbody.appendChild(tr);
    });
  }

  function topup() {
    const isA = Auth.isAdmin();
    byId('topupAdmin').style.display = isA ? 'grid' : 'none';
    byId('topupInfo').style.display = isA ? 'none' : 'grid';
    if (!isA) {
      const last = State.get().treasury.notes[0];
      byId('lastIncome').innerHTML = last ? `Letzte Einnahme: ${curHTML(last.amount)} – ${last.note || ''}` : '';
    }
  }

  function deps() {
    const s = State.get();
    const body = byId('depTable').querySelector('tbody');
    body.innerHTML = '';
    s.departments.forEach(dep => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><b>${dep.code}</b></td><td>${dep.name}</td><td>${curHTML(dep.budget)}</td><td><div class="row" style="gap:6px"><button class="btn soft" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.allocPrompt('${dep.id}')">Zuweisen</button><button class="btn ghost" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.editDepPrompt('${dep.id}')">Bearbeiten</button><button class="btn bad" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.deleteDep('${dep.id}')">Löschen</button></div></td>`;
      body.appendChild(tr);
    });
    const sel = byId('reqDept');
    sel.innerHTML = '';
    s.departments.forEach(d => {
      const o = document.createElement('option');
      o.value = d.id;
      o.textContent = `${d.name} (${d.code})`;
      sel.appendChild(o);
    });
  }

  function requests() {
    const s = State.get();
    const body = byId('reqTable').querySelector('tbody');
    body.innerHTML = '';
    s.requests.forEach(r => {
      const dep = s.departments.find(d => d.id === r.deptId);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.ts).toLocaleString('de-DE')}</td><td>${r.title}</td><td>${dep ? dep.name : ''}</td><td>${curHTML(r.amount)}</td><td>${r.status}</td><td><div class="row" style="gap:6px"><button class="btn soft" ${(Auth.isMinister()||Auth.isAdmin())&&r.status==='pending'?'':'disabled'} onclick="Actions.approveReq('${r.id}')">OK</button><button class="btn ghost" ${(Auth.isMinister()||Auth.isAdmin())&&r.status==='pending'?'':'disabled'} onclick="Actions.rejectReq('${r.id}')">X</button><button class="btn bad" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.deleteReq('${r.id}')">DEL</button></div></td>`;
      body.appendChild(tr);
    });
  }

  function users() {
    const body = byId('userTable')?.querySelector('tbody');
    if (!body) return;
    body.innerHTML = '';
    State.get().users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${u.active?'<span>aktiv</span>':'<span>deaktiviert</span>'}</td><td><div class="row" style="gap:6px"><button class="btn ghost" ${!Auth.isAdmin()?'disabled':''} onclick="Actions.editUserPrompt('${u.username}')">Edit</button><button class="btn soft" ${!Auth.isAdmin()?'disabled':''} onclick="Actions.toggleUser('${u.username}')">${u.active?'Off':'On'}</button><button class="btn bad" ${!Auth.isAdmin()||u.username==='Admin01'?'disabled':''} onclick="Actions.deleteUser('${u.username}')">DEL</button></div></td>`;
      body.appendChild(tr);
    });
    document.querySelector('[data-tab="users"]').style.display = Auth.isAdmin() ? 'inline-block' : 'none';
  }

  function renderAll() {
    if (!State.get().session.user) { showLogin(); return; }
    showApp(); header(); topup(); audit(); deps(); requests(); users();
  }

  return { showLogin, showApp, renderAll };
})();

    

  // ===== BLOCK: ACTIONS =====
const Actions = (() => {
  function bind() {
    // Login / Logout
    byId('btnLogin').onclick  = () => {
      if (!Auth.login(byId('loginUser').value.trim(), byId('loginPass').value.trim())) {
        alert('Abgewiesen');
      }
    };
    byId('btnLogout').onclick = Auth.logout;

    // Admin: Fond aufladen
    const btnTop = byId('btnTopup');
    if (btnTop) {
      btnTop.onclick = () => {
        if (!Auth.isAdmin()) return alert('Nur Admin');
        const amt  = parseFloat(byId('topupAmount').value || '0');
        if (!(amt > 0)) return alert('Betrag');
        const note = byId('topupNote').value.trim();
        const s = State.get();
        s.treasury.fund += amt;
        s.treasury.notes.unshift({ ts: now(), amount: amt, note });
        State.log(s.session.user.username, 'fund_topup', amt + ' // ' + note);
        State.save(); UI.renderAll();
        byId('topupAmount').value = '';
        byId('topupNote').value   = '';
      };
    }

    // Abteilung anlegen
    const btnAddDep = byId('btnAddDep');
    if (btnAddDep) {
      btnAddDep.onclick = () => {
        if (!(Auth.isMinister() || Auth.isAdmin())) return alert('Nur Finanzminister/Admin');
        const name = byId('depName').value.trim();
        const code = byId('depCode').value.trim().toUpperCase();
        if (!name || !code) return alert('Name/Kürzel');
        const s = State.get();
        if (s.departments.some(d => d.code === code)) return alert('Kürzel vergeben');
        s.departments.push({ id: crypto.randomUUID(), name, code, budget: 0 });
        State.log(s.session.user.username, 'dep_create', code + ' ' + name);
        State.save(); UI.renderAll();
        byId('depName').value = '';
        byId('depCode').value = '';
      };
    }

    // Antrag erstellen
    const btnReq = byId('btnSubmitReq');
    if (btnReq) {
      btnReq.onclick = () => {
        const title  = byId('reqTitle').value.trim();
        const deptId = byId('reqDept').value;
        const amount = parseFloat((byId('reqAmount').value || '').replace(',', '.'));
        const desc   = byId('reqDesc').value.trim();
        if (!title || !deptId || !(amount > 0)) return alert('Felder');
        const s = State.get();
        s.requests.unshift({
          id: crypto.randomUUID(), ts: now(), title, deptId, amount, desc,
          status: 'pending', createdBy: s.session.user.username
        });
        State.log(s.session.user.username, 'req_create', title + ' ' + amount);
        State.save(); UI.renderAll();
        byId('reqTitle').value  = '';
        byId('reqAmount').value = '';
        byId('reqDesc').value   = '';
      };
    }

    // Nutzer anlegen (FEHLTE)
    const btnAddUser = byId('btnAddUser');
    if (btnAddUser) {
      btnAddUser.onclick = () => {
        if (!Auth.isAdmin()) return alert('Nur Admin');
        const username = byId('userName').value.trim();
        const role     = byId('userRole').value.trim();
        const pass     = byId('userPass').value;
        if (!username || !role || !pass) return alert('Alle Felder ausfüllen');
        const s = State.get();
        if (s.users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
          return alert('Benutzer existiert bereits');
        }
        s.users.push({ username, role, password: pass, active: true });
        State.log(s.session.user.username, 'user_create', `${username} // ${role}`);
        State.save(); UI.renderAll();
        byId('userName').value = '';
        byId('userPass').value = '';
      };
    }

    // Passwort ändern (aktueller Nutzer)
    const btnPwd = byId('btnChangePass');
    if (btnPwd) {
      btnPwd.onclick = () => {
        const np = byId('newPass').value.trim();
        if (!np) return;
        const s = State.get();
        const u = s.users.find(x => x.username === s.session.user.username);
        u.password = np;
        State.save();
        byId('newPass').value = '';
      };
    }

    // Reset
    const btnReset = byId('btnReset');
    if (btnReset) {
      btnReset.onclick = () => {
        if (!confirm('Zurücksetzen?')) return;
        localStorage.removeItem(LS_KEY);
        State.load(); State.save(); UI.renderAll();
      };
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(t => {
      t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const key = t.dataset.tab;
        ['dashboard','deps','requests','users','settings'].forEach(k => {
          const el = byId('tab-'+k);
          if (el) el.style.display = (k === key) ? 'block' : 'none';
        });
      };
    });
  }

  // ---- Exposed inline handlers bleiben unverändert ----
  function deleteDep(id){ /* ... wie bei dir ... */ }
  function editDepPrompt(id){ /* ... */ }
  function allocPrompt(id){ /* ... */ }
  function approveReq(id){ /* ... */ }
  function rejectReq(id){ /* ... */ }
  function deleteReq(id){ /* ... */ }
  function editUserPrompt(username){ /* ... */ }
  function toggleUser(username){ /* ... */ }
  function deleteUser(username){ /* ... */ }

  return { bind, deleteDep, editDepPrompt, allocPrompt, approveReq, rejectReq, deleteReq, editUserPrompt, toggleUser, deleteUser };
})();


// ===== BLOCK: BOOT =====
(function Boot(){
  const loader = byId('loader');
  const wrap   = byId('rootWrap');

  function finish(){
    if (loader) loader.style.display = 'none';
    if (wrap)   wrap.style.opacity   = 1;
  }

  try {
    State.load();

    // Wenn alles geladen ist, App binden und rendern
    window.addEventListener('load', () => {
      try {
        Actions.bind();
        if (State.get().session.user) { UI.showApp(); } else { UI.showLogin(); }
        UI.renderAll();
      } catch (e) {
        console.error('Init error:', e);
      } finally {
        finish(); // Loader sicher aus
      }
    });

    // Failsafe: selbst wenn 'load' nicht feuert
    setTimeout(finish, 2500);
  } catch (e) {
    console.error('Boot error:', e);
    finish();
  }
})();


  </script>
</body>
</html>
