<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMPERIALES FINANZ SYSTEM</title>
  <link rel="icon" href="log_imp.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

  <!-- ========================= BLOCK: STYLES (CRT + UI) ========================= -->
  <style>
    :root{ --bg:#000; --panel:#0d0d0d; --ink:#e6e6e6; --muted:#9a9a9a; --line:#2a2a2a; --ring:#3a3a3a; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.5 'Orbitron', system-ui, sans-serif; position:relative
    }

    /* CRT Scanlines */
    body::after{
      content:"";position:fixed;inset:0;pointer-events:none;
      background:repeating-linear-gradient(to bottom,
        rgba(255,255,255,.035), rgba(255,255,255,.035) 1px,
        transparent 1px, transparent 3px);
      mix-blend-mode:overlay
    }
    /* CRT Static + Sweep */
    .fx-layer{position:fixed;inset:0;pointer-events:none;z-index:9990}
    .fx-noise{
      background:repeating-linear-gradient(0deg, rgba(255,255,255,.022) 0 1px, transparent 1px 2px),
                  repeating-linear-gradient(90deg, rgba(255,255,255,.018) 0 1px, transparent 1px 3px);
      animation:noiseFlash 600ms steps(2,end) infinite
    }
    @keyframes noiseFlash{50%{opacity:.8}0%,100%{opacity:.95}}
    .fx-sweep{
      background:linear-gradient(to bottom, transparent 0%, rgba(255,255,255,.08) 50%, transparent 100%);
      height:15%; width:100%; position:fixed; left:0; top:-20%;
      mix-blend-mode:screen; z-index:9991; animation:sweep 6s linear infinite
    }
    @keyframes sweep{0%{transform:translateY(-30vh)} 100%{transform:translateY(130vh)}}
    @keyframes flicker{0%,100%{opacity:.98} 50%{opacity:.94}}
    .crt{animation:flicker 3s infinite}

    /* UI Shell */
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .brand{display:flex;align-items:center;gap:.6rem}
    .logo{width:20px;height:20px;filter:brightness(0) invert(1) contrast(1.05);opacity:.95}
    .h1{font-size:20px;font-weight:800;letter-spacing:.06em;text-shadow:0 0 6px rgba(255,255,255,.25)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 20px rgba(0,0,0,.5)}
    .pad{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .btn{appearance:none;border:1px solid var(--ink);padding:8px 12px;border-radius:8px;background:transparent;color:var(--ink);font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.08em}
    .btn:hover{background:#111}
    .btn.bad{border-color:#fff;background:#111}
    .btn.soft{border-color:#777;color:#ddd}
    .btn.ghost{border-color:#555;color:#ccc}
    .input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--ring);background:#0a0a0a;color:var(--ink);outline:none}
    .input:focus, select:focus, textarea:focus{box-shadow:0 0 0 2px rgba(255,255,255,.08)}
    .label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em}
    .grid{display:grid;gap:12px}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.stats{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .stat{padding:14px 16px;border-radius:10px;background:#0a0a0a;border:1px solid var(--line)}
    .stat h3{margin:0 0 4px 0;font:700 12px/1.2 'Orbitron', sans-serif;letter-spacing:.08em;color:#cfcfcf}
    .stat .v{font-size:20px;font-weight:800;display:flex;align-items:center;gap:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:#c8c8c8;font-weight:700;text-transform:uppercase;letter-spacing:.08em}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid var(--line);cursor:pointer}
    .tab.active{background:#101010;border-color:#777}
    .topbar{display:flex;align-items:center;gap:12px;padding:10px 0}
    .sp{flex:1}

    /* Currency + icons forced white */
    .currency-icon{width:16px;height:16px;vertical-align:-3px;filter:brightness(0) invert(1) contrast(1.05);opacity:.95}
    .cur{display:inline-flex;align-items:center;gap:6px}

    /* --- Charts --- */
    .chart-wrap{display:grid;gap:12px}
    .chart-card{background:#0a0a0a;border:1px solid var(--line);border-radius:10px;padding:12px}
    .chart-title{font-size:12px;letter-spacing:.08em;color:#cfcfcf;margin:0 0 6px}
    canvas.chart{width:100%;height:180px;display:block}
    .small{font-size:12px;color:#c8c8c8}

    /* Loader */
    .loader{position:fixed;inset:0;background:#000;display:grid;place-items:center;z-index:10000}
    .loader-inner{display:grid;gap:14px;place-items:center;color:#e8e8ea}
    .seal-img{width:92px;height:92px;filter:brightness(0) invert(1) contrast(1.05);opacity:.98}
    .progress{display:flex;gap:6px}
    .dot{width:8px;height:8px;border-radius:50%;background:#fff;opacity:.25}
    .dot:nth-child(1){animation:d 1.2s infinite}
    .dot:nth-child(2){animation:d 1.2s .2s infinite}
    .dot:nth-child(3){animation:d 1.2s .4s infinite}
    @keyframes d{0%,100%{opacity:.25}50%{opacity:1}}
  </style>
</head>
<body class="crt">
  <!-- CRT FX Overlays -->
  <div class="fx-layer fx-noise"></div>
  <div class="fx-sweep"></div>

  <!-- ========================= BLOCK: LOADER ========================= -->
  <div id="loader" class="loader">
    <div class="loader-inner">
      <img src="log_imp.png" alt="Imperiales Siegel" class="seal-img" />
      <div class="progress"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- ========================= BLOCK: SHELL ========================= -->
  <div class="wrap" style="opacity:0;transition:opacity .4s" id="rootWrap">
    <div class="topbar">
      <div class="brand"><img src="log_imp.png" class="logo" alt="Logo"/><div class="h1">IMPERIALES FINANZ SYSTEM</div></div>
      <div class="sp"></div>
      <button class="btn soft" id="btnLogout" style="display:none">Abmelden</button>
    </div>

    <!-- ========================= BLOCK: FIRST-RUN SETUP (Admin anlegen) ========================= -->
    <div id="viewSetup" class="card pad" style="max-width:520px;margin:40px auto 0 auto;display:none">
      <div class="grid">
        <div class="label">Ersteinrichtung – Admin anlegen</div>
        <div>
          <label class="label">Admin-Benutzername</label>
          <input class="input" id="setupUser" autocomplete="off"/>
        </div>
        <div>
          <label class="label">Admin-Passwort</label>
          <input class="input" id="setupPass" type="password" autocomplete="new-password"/>
        </div>
        <div class="row" style="align-items:center;gap:8px">
          <button class="btn" id="btnSetup">Anlegen & Weiter</button>
        </div>
      </div>
    </div>

    <!-- ========================= BLOCK: LOGIN VIEW ========================= -->
    <div id="viewLogin" class="card pad" style="max-width:520px;margin:40px auto 0 auto;display:none">
      <div class="grid">
        <div>
          <label class="label">Benutzername</label>
          <input class="input" id="loginUser" autocomplete="username"/>
        </div>
        <div>
          <label class="label">Passwort</label>
          <input class="input" id="loginPass" type="password" autocomplete="current-password"/>
        </div>
        <div class="row" style="align-items:center;gap:8px">
          <button class="btn" id="btnLogin">Anmelden</button>
        </div>
      </div>
    </div>

    <!-- ========================= BLOCK: APP ========================= -->
    <div id="app" style="display:none">
      <div class="row">
        <div class="col card pad">
          <div class="row" style="align-items:center">
            <div class="h1" id="roleBadge">Rolle</div><span id="userBadge"></span>
            <div class="sp"></div>
          </div>
          <div class="stats" style="margin-top:12px">
            <div class="stat"><h3>Gesamtbudget</h3><div class="v" id="statTotal"></div></div>
            <div class="stat"><h3>Zugewiesen</h3><div class="v" id="statAllocated"></div></div>
            <div class="stat"><h3>Verfügbar</h3><div class="v" id="statAvailable"></div></div>
            <div class="stat"><h3>Offene Anträge</h3><div class="v" id="statPending">0</div></div>
          </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="deps">Abteilungen</div>
        <div class="tab" data-tab="requests">Anträge</div>
        <div class="tab" data-tab="users">Nutzer</div>
        <div class="tab" data-tab="settings">Einstellungen</div>
      </div>

      <!-- ========================= BLOCK: TAB DASHBOARD ========================= -->
      <div id="tab-dashboard" class="card pad">
        <div class="row">
          <!-- Linke Seite: Finanz-Infos -->
          <div class="col">
            <div id="finInfo" class="chart-wrap" style="display:none">
              <div class="chart-card">
                <h4 class="chart-title">Budget-Verteilung nach Abteilung</h4>
                <canvas id="chartAlloc" class="chart"></canvas>
                <div class="small" id="allocLegend"></div>
              </div>
              <div class="chart-card">
                <h4 class="chart-title">Trend & Prognose (Fond)</h4>
                <canvas id="chartTrend" class="chart"></canvas>
                <div class="small" id="forecastText"></div>
              </div>
              <div id="auditorPane" class="chart-card" style="display:none">
                <h4 class="chart-title">Transparenz – Letzte Einnahmen & Zuweisungen</h4>
                <div class="row">
                  <div class="col">
                    <div class="small">Einnahmen (Top-Ups)</div>
                    <table style="width:100%">
                      <thead><tr><th class="small">Zeit</th><th class="small">Betrag</th><th class="small">Notiz</th></tr></thead>
                      <tbody id="incTable"></tbody>
                    </table>
                  </div>
                  <div class="col">
                    <div class="small">Ausgaben (Zuweisungen)</div>
                    <table style="width:100%">
                      <thead><tr><th class="small">Zeit</th><th class="small">Abt.</th><th class="small">Betrag</th></tr></thead>
                      <tbody id="expTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Rechte Seite: Logs (nur Admin & Prüfer) -->
          <div class="col">
            <div id="auditCard">
              <table id="auditTable">
                <thead><tr><th>Zeit</th><th>Aktion</th><th>Details</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB DEPARTMENTS ========================= -->
      <div id="tab-deps" class="card pad" style="display:none">
        <div class="row" style="align-items:end">
          <div class="col">
            <label class="label">Abteilungsname</label>
            <input class="input" id="depName" />
          </div>
          <div class="col" style="max-width:200px">
            <label class="label">Kürzel</label>
            <input class="input" id="depCode" />
          </div>
          <div class="col" style="max-width:220px">
            <button class="btn" id="btnAddDep">Anlegen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="depTable">
            <thead><tr><th>Kürzel</th><th>Abteilung</th><th>Budget</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB REQUESTS ========================= -->
      <div id="tab-requests" class="card pad" style="display:none">
        <div class="row" style="align_items:end">
          <div class="col">
            <label class="label">Titel</label>
            <input class="input" id="reqTitle" />
          </div>
          <div class="col">
            <label class="label">Abteilung</label>
            <select id="reqDept" class="input"></select>
          </div>
          <div class="col" style="max-width:200px">
            <label class="label">Betrag <img src="Credits.png" class="currency-icon" alt="Credits"/></label>
            <input class="input" id="reqAmount" type="number" min="0" step="0.01" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="label">Beschreibung</label>
            <textarea class="input" id="reqDesc" rows="2"></textarea>
          </div>
          <div class="col" style="max-width:220px;display:flex;align-items:flex-end">
            <button class="btn" id="btnSubmitReq">Antrag erstellen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="reqTable">
            <thead><tr><th>Zeit</th><th>Titel</th><th>Abteilung</th><th>Betrag</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB USERS (ADMIN) ========================= -->
      <div id="tab-users" class="card pad" style="display:none">
        <div class="row" style="align-items:end">
          <div class="col">
            <label class="label">Benutzername</label>
            <input class="input" id="userName" />
          </div>
          <div class="col" style="max-width:220px">
            <label class="label">Rolle</label>
            <select id="userRole" class="input">
              <option>Administrator</option>
              <option>Finanzminister</option>
              <option>Prüfer</option>
              <option>Gouverneur</option>
              <option>Schreiber</option>
            </select>
          </div>
          <div class="col">
            <label class="label">Passwort</label>
            <input class="input" id="userPass" type="password" />
          </div>
          <div class="col" style="max-width:220px">
            <button class="btn" id="btnAddUser">Nutzer anlegen</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table id="userTable">
            <thead><tr><th>Benutzername</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ========================= BLOCK: TAB SETTINGS (ADMIN ONLY) ========================= -->
      <div id="tab-settings" class="card pad" style="display:none">
        <div class="row">
          <div class="col" style="max-width:360px">
            <label class="label">Neues Passwort</label>
            <input class="input" id="newPass" type="password" />
            <div class="row" style="margin-top:8px"><button class="btn" id="btnChangePass">Passwort ändern</button></div>
          </div>
          <div class="col">
            <div class="row" style="margin-top:12px;gap:8px">
              <button class="btn soft" id="btnReset">Alles zurücksetzen</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ========================= BLOCK: SCRIPT (MODULED) ========================= -->
  <script>
  // ===== BLOCK: CONSTANTS & HELPERS =====
  const LS_KEY = 'imperial_finance_blocks_v3';
  const byId = id => document.getElementById(id);
  const now = () => new Date().toISOString();
  const numDE = n => Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const curHTML = n => `<span class="cur"><img src="Credits.png" class="currency-icon" alt="Credits"/> ${numDE(n)}</span>`;

  // --- simple monochrome Charts (ohne Lib) ---
  function drawPie(canvas, entries){
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth, H = canvas.clientHeight;
    canvas.width = W*dpr; canvas.height = H*dpr; ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,W,H);
    const total = entries.reduce((a,e)=>a+e.value,0)||1;
    const cx=W/2, cy=H/2, r=Math.min(W,H)*0.38;
    let a0 = -Math.PI/2, i=0;
    entries.forEach(e=>{
      const a1 = a0 + (e.value/total)*Math.PI*2;
      const g = Math.round(220 - (i*160/Math.max(1,entries.length-1)));
      ctx.fillStyle = `rgb(${g},${g},${g})`;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath(); ctx.fill();
      a0 = a1; i++;
    });
    ctx.strokeStyle = 'rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
  }
  function drawLine(canvas, points){
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth, H = canvas.clientHeight;
    canvas.width = W*dpr; canvas.height = H*dpr; ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,W,H);
    if(points.length<2) return;
    const ys = points.map(p=>p.y); const yMin=Math.min(...ys), yMax=Math.max(...ys);
    const pad=12;
    ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=2;
    ctx.beginPath();
    points.forEach((p,i)=>{
      const x = pad + p.x*(W-pad*2);
      const y = H-pad - ((p.y - yMin)/(yMax - yMin || 1))*(H-pad*2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    if(points.forecastY!==undefined){
      const last = points[points.length-1];
      const x1 = pad + last.x*(W-pad*2);
      const y1 = H-pad - ((last.y - yMin)/(yMax - yMin || 1))*(H-pad*2);
      const x2 = pad + 1*(W-pad*2);
      const y2 = H-pad - ((points.forecastY - yMin)/(yMax - yMin || 1))*(H-pad*2);
      ctx.setLineDash([5,4]); ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); ctx.setLineDash([]);
    }
  }

  // passwort → SHA-256 Hex
  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // ===== BLOCK: STATE =====
  const State = (()=>{
    const initial = ()=>({
      users:[], // keine Nutzer im Code – Ersteinrichtung legt Admin an
      session:{user:null},
      treasury:{fund:0, notes:[]},
      departments:[],
      requests:[],
      audit:[{ts:now(), actor:'system', action:'init', details:'Fond=0; Setup erforderlich'}]
    });
    let s = null;
    const load = ()=>{ const raw = localStorage.getItem(LS_KEY); s = raw? JSON.parse(raw): initial(); };
    const save = ()=> localStorage.setItem(LS_KEY, JSON.stringify(s));
    const log = (actor,action,details)=>{ s.audit.unshift({ts:now(),actor,action,details}); if(s.audit.length>2000) s.audit.pop(); };
    return { get:()=>s, set:v=>{s=v;}, load, save, log, initial };
  })();

  // ===== BLOCK: AUTH =====
  const Auth = (()=>{
    const isAdmin = ()=> State.get().session.user?.role==='Administrator';
    const isMinister = ()=> State.get().session.user?.role==='Finanzminister';
    const needsSetup = ()=> (State.get().users||[]).length===0;

    const login = async (u,p)=>{
      const s = State.get();
      const user = s.users.find(x=>x.active && x.username===u);
      if(!user) return false;
      const hash = await sha256Hex(p);
      if(user.passHash !== hash) return false;
      s.session.user = {username:user.username, role:user.role};
      State.log(u,'login','ok'); State.save(); UI.renderAll();
      return true;
    };
    const logout = ()=>{ const s=State.get(); if(s.session.user) State.log(s.session.user.username,'logout','bye'); s.session.user=null; State.save(); UI.showLogin(); };
    const createInitialAdmin = async (username, pass)=>{
      const s=State.get();
      if((s.users||[]).length>0) return false;
      const passHash = await sha256Hex(pass);
      s.users=[{username, role:'Administrator', passHash, active:true}];
      State.log('system','setup_admin', username);
      State.save();
      return true;
    };
    return { isAdmin, isMinister, needsSetup, login, logout, createInitialAdmin };
  })();

  // ===== BLOCK: ROLE HELPERS =====
  const Role = {
    isAdmin: () => Auth.isAdmin(),
    isMinister: () => Auth.isMinister(),
    isGovernor: () => State.get().session.user?.role === 'Gouverneur',
    isAuditor: () => State.get().session.user?.role === 'Prüfer'
  };
  const canSeeFinInfo = () => Role.isMinister() || Role.isGovernor() || Role.isAuditor() || Role.isAdmin();
  const canSeeLogs    = () => Role.isAuditor() || Role.isAdmin();

  // ===== BLOCK: COMPUTE =====
  const Compute = (()=>{
    const totalAllocated = ()=> State.get().departments.reduce((a,d)=>a+(d.budget||0),0);
    const available = ()=> (State.get().treasury.fund||0) - totalAllocated();
    const pendingCount = ()=> State.get().requests.filter(r=>r.status==='pending').length;
    return { totalAllocated, available, pendingCount };
  })();

  // ===== BLOCK: UI RENDER =====
  const UI = (()=>{
    const showSetup = ()=>{ byId('app').style.display='none'; byId('viewLogin').style.display='none'; byId('viewSetup').style.display='block'; byId('btnLogout').style.display='none'; };
    const showLogin = ()=>{ byId('app').style.display='none'; byId('viewSetup').style.display='none'; byId('viewLogin').style.display='block'; byId('btnLogout').style.display='none'; };
    const showApp   = ()=>{ byId('viewSetup').style.display='none'; byId('viewLogin').style.display='none'; byId('app').style.display='block'; byId('btnLogout').style.display='inline-block'; };

    function header(){
      const s = State.get(); if(!s.session.user) return;
      byId('roleBadge').textContent   = s.session.user.role;
      byId('userBadge').textContent   = ' '+s.session.user.username;
      byId('statTotal').innerHTML     = curHTML(s.treasury.fund);
      byId('statAllocated').innerHTML = curHTML(Compute.totalAllocated());
      byId('statAvailable').innerHTML = curHTML(Compute.available());
      byId('statPending').textContent = String(Compute.pendingCount());
    }

    function audit(){
      const card = byId('auditCard');
      if(!canSeeLogs()){ if(card) card.style.display='none'; return; }
      if(card) card.style.display='block';
      const tbody = byId('auditTable').querySelector('tbody'); tbody.innerHTML='';
      State.get().audit.slice(0,10).forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${new Date(e.ts).toLocaleString('de-DE')}</td><td>${e.actor} – ${e.action}</td><td>${e.details||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function topup(){
      const isA = Auth.isAdmin();
      byId('topupAdmin').style.display = isA? 'grid':'none';
      byId('topupInfo').style.display  = isA? 'none':'grid';
      if(!isA){
        const last = State.get().treasury.notes[0];
        byId('lastIncome').innerHTML = last? `Letzte Einnahme: ${curHTML(last.amount)} – ${last.note||''}` : '';
      }
    }

    function finInfo(){
      const s = State.get();
      const wrap = byId('finInfo');
      if(!canSeeFinInfo()){ if(wrap) wrap.style.display='none'; return; }
      wrap.style.display='grid';

      // Pie: Budget-Verteilung
      const entries = s.departments.map(d=>({label:`${d.name} (${d.code})`, value: d.budget||0}));
      const total = entries.reduce((a,e)=>a+e.value,0);
      drawPie(byId('chartAlloc'), entries);
      byId('allocLegend').textContent = total>0
        ? entries.map(e=>`${e.label}: ${numDE(e.value)} (${((e.value/total)*100||0).toFixed(1)}%)`).join(' • ')
        : 'Noch keine Zuweisungen.';

      // Trend & Prognose (einfacher Forecast)
      const events = [];
      s.audit.slice().reverse().forEach(a=>{
        if(a.action==='fund_topup'){
          const amt=parseFloat(String(a.details).split(' // ')[0])||0;
          events.push({ts:a.ts, delta:+amt});
        }
        if(a.action==='alloc' || a.action==='req_approve'){
          const m = String(a.details).match(/(\d+(\.\d+)?)/);
          const amt = m? parseFloat(m[1]) : NaN;
          if(!isNaN(amt)) events.push({ts:a.ts, delta:-amt});
        }
      });
      events.sort((a,b)=>new Date(a.ts)-new Date(b.ts));
      let v = s.treasury.fund - events.reduce((acc,e)=>acc+e.delta,0);
      const pts = events.slice(-12).map((e,i)=>{ v += e.delta; return {x:i/Math.max(1,Math.min(11,events.length-1)), y:v}; });
      if(pts.length<2){ pts.push({x:0,y:s.treasury.fund},{x:1,y:s.treasury.fund}); }
      const last3 = events.slice(-3).map(e=>e.delta);
      const avg = last3.length? last3.reduce((a,b)=>a+b,0)/last3.length : 0;
      const forecast = (pts[pts.length-1]?.y||0) + avg;
      pts.forecastY = forecast;
      drawLine(byId('chartTrend'), pts);
      byId('forecastText').textContent = `Prognose nächster Schritt: ${numDE(forecast)} Cr`;

      // Prüfer/Admin: Einnahmen/Ausgabenlisten
      const auditorPane = byId('auditorPane');
      auditorPane.style.display = (Role.isAuditor() || Role.isAdmin()) ? 'block' : 'none';
      if(auditorPane.style.display==='block'){
        const incBody = byId('incTable');  incBody.innerHTML='';
        const expBody = byId('expTable');  expBody.innerHTML='';
        s.treasury.notes.slice(0,8).forEach(n=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td class="small">${new Date(n.ts).toLocaleString('de-DE')}</td><td class="small">${numDE(n.amount)}</td><td class="small">${n.note||''}</td>`;
          incBody.appendChild(tr);
        });
        s.audit.filter(a=>a.action==='alloc' || a.action==='req_approve').slice(0,8).forEach(a=>{
          const dep = s.departments.find(d=>a.details?.includes(d.code));
          const m   = String(a.details).match(/(\d+(\.\d+)?)/);
          const amt = m? numDE(parseFloat(m[1])):'';
          const tr=document.createElement('tr');
          tr.innerHTML=`<td class="small">${new Date(a.ts).toLocaleString('de-DE')}</td><td class="small">${dep?dep.code:''}</td><td class="small">${amt}</td>`;
          expBody.appendChild(tr);
        });
      }
    }

    function deps(){
      const s = State.get(); const body = byId('depTable').querySelector('tbody'); body.innerHTML='';
      s.departments.forEach(dep=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><b>${dep.code}</b></td>
          <td>${dep.name}</td>
          <td>${curHTML(dep.budget)}</td>
          <td>
            <div class="row" style="gap:6px">
              <button class="btn soft" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.allocPrompt('${dep.id}')">Zuweisen</button>
              <button class="btn ghost" ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.editDepPrompt('${dep.id}')">Bearbeiten</button>
              <button class="btn bad"  ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.deleteDep('${dep.id}')">Löschen</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });
      const sel = byId('reqDept'); sel.innerHTML='';
      s.departments.forEach(d=>{
        const o=document.createElement('option'); o.value=d.id; o.textContent=`${d.name} (${d.code})`; sel.appendChild(o);
      });
    }

    function requests(){
      const s = State.get(); const body = byId('reqTable').querySelector('tbody'); body.innerHTML='';
      s.requests.forEach(r=>{
        const dep=s.departments.find(d=>d.id===r.deptId);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.ts).toLocaleString('de-DE')}</td>
          <td>${r.title}</td>
          <td>${dep?dep.name:''}</td>
          <td>${curHTML(r.amount)}</td>
          <td>${r.status}</td>
          <td>
            <div class="row" style="gap:6px">
              <button class="btn soft" ${(Auth.isMinister()||Auth.isAdmin())&&r.status==='pending'?'':'disabled'} onclick="Actions.approveReq('${r.id}')">OK</button>
              <button class="btn ghost" ${(Auth.isMinister()||Auth.isAdmin())&&r.status==='pending'?'':'disabled'} onclick="Actions.rejectReq('${r.id}')">X</button>
              <button class="btn bad"  ${(Auth.isMinister()||Auth.isAdmin())?'':'disabled'} onclick="Actions.deleteReq('${r.id}')">DEL</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });
    }

    function users(){
      const body = byId('userTable')?.querySelector('tbody'); if(!body) return; body.innerHTML='';
      State.get().users.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>${u.active?'<span>aktiv</span>':'<span>deaktiviert</span>'}</td>
          <td>
            <div class="row" style="gap:6px">
              <button class="btn ghost" ${!Auth.isAdmin()?'disabled':''} onclick="Actions.editUserPrompt('${u.username}')">Edit</button>
              <button class="btn soft"  ${!Auth.isAdmin()?'disabled':''} onclick="Actions.toggleUser('${u.username}')">${u.active?'Off':'On'}</button>
              <button class="btn bad"   ${!Auth.isAdmin()?'disabled':''} onclick="Actions.deleteUser('${u.username}')">DEL</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });
    }

    function renderAll(){
      if (Auth.needsSetup()) { showSetup(); return; }
      if(!State.get().session.user){ showLogin(); return; }
      showApp(); header(); topup(); finInfo(); audit(); deps(); requests(); users();

      // Tabsichtbarkeit: Users + Settings nur Admin
      const usersTab = document.querySelector('[data-tab="users"]');
      if (usersTab) usersTab.style.display = Auth.isAdmin()? 'inline-block':'none';
      const settingsTab = document.querySelector('[data-tab="settings"]');
      if (settingsTab) settingsTab.style.display = Auth.isAdmin()? 'inline-block':'none';
      if (!Auth.isAdmin()) { const sv=byId('tab-settings'); if (sv) sv.style.display='none'; }
      // Logs-Card falls nicht erlaubt
      if (!canSeeLogs()) { const ac=byId('auditCard'); if(ac) ac.style.display='none'; }
    }

    return { showSetup, showLogin, showApp, renderAll };
  })();

  // ===== BLOCK: ACTIONS =====
  var Actions = (() => {
    function bind(){
      // Setup (Ersteinrichtung)
      const btnSetup = byId('btnSetup');
      if (btnSetup){
        btnSetup.onclick = async () => {
          const u = byId('setupUser').value.trim();
          const p = byId('setupPass').value;
          if (!u || !p) return alert('Benutzername & Passwort angeben');
          const ok = await Auth.createInitialAdmin(u, p);
          if (!ok) return alert('Setup bereits erledigt');
          byId('setupPass').value=''; byId('setupUser').value='';
          UI.renderAll();
        };
      }

      // Login / Logout
      const btnLogin = byId('btnLogin');
      if (btnLogin){
        btnLogin.onclick  = async () => {
          const u = byId('loginUser').value.trim();
          const p = byId('loginPass').value;
          if (!await Auth.login(u,p)) alert('Abgewiesen');
        };
      }
      byId('btnLogout').onclick = Auth.logout;

      // Admin: Fond aufladen
      const btnTop = byId('btnTopup');
      if (btnTop) {
        btnTop.onclick = () => {
          if (!Auth.isAdmin()) return alert('Nur Admin');
          const amt  = parseFloat(byId('topupAmount').value || '0');
          if (!(amt > 0)) return alert('Betrag');
          const note = byId('topupNote').value.trim();
          const s = State.get();
          s.treasury.fund += amt;
          s.treasury.notes.unshift({ ts: now(), amount: amt, note });
          State.log(s.session.user.username, 'fund_topup', amt + ' // ' + note);
          State.save(); UI.renderAll();
          byId('topupAmount').value = '';
          byId('topupNote').value   = '';
        };
      }

      // Abteilung anlegen
      const btnAddDep = byId('btnAddDep');
      if (btnAddDep) {
        btnAddDep.onclick = () => {
          if (!(Auth.isMinister() || Auth.isAdmin())) return alert('Nur Finanzminister/Admin');
          const name = byId('depName').value.trim();
          const code = byId('depCode').value.trim().toUpperCase();
          if (!name || !code) return alert('Name/Kürzel');
          const s = State.get();
          if (s.departments.some(d => d.code === code)) return alert('Kürzel vergeben');
          s.departments.push({ id: crypto.randomUUID(), name, code, budget: 0 });
          State.log(s.session.user.username, 'dep_create', code + ' ' + name);
          State.save(); UI.renderAll();
          byId('depName').value = '';
          byId('depCode').value = '';
        };
      }

      // Antrag erstellen
      const btnReq = byId('btnSubmitReq');
      if (btnReq) {
        btnReq.onclick = () => {
          const title  = byId('reqTitle').value.trim();
          const deptId = byId('reqDept').value;
          const amount = parseFloat((byId('reqAmount').value || '').replace(',', '.'));
          const desc   = byId('reqDesc').value.trim();
          if (!title || !deptId || !(amount > 0)) return alert('Felder');
          const s = State.get();
          s.requests.unshift({
            id: crypto.randomUUID(), ts: now(), title, deptId, amount, desc,
            status: 'pending', createdBy: s.session.user.username
          });
          State.log(s.session.user.username, 'req_create', title + ' ' + amount);
          State.save(); UI.renderAll();
          byId('reqTitle').value  = '';
          byId('reqAmount').value = '';
          byId('reqDesc').value   = '';
        };
      }

      // Nutzer anlegen
      const btnAddUser = byId('btnAddUser');
      if (btnAddUser) {
        btnAddUser.onclick = async () => {
          if (!Auth.isAdmin()) return alert('Nur Admin');
          const username = byId('userName').value.trim();
          const role     = byId('userRole').value.trim();
          const pass     = byId('userPass').value;
          if (!username || !role || !pass) return alert('Alle Felder ausfüllen');
          const s = State.get();
          if (s.users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
            return alert('Benutzer existiert bereits');
          }
          const passHash = await sha256Hex(pass);
          s.users.push({ username, role, passHash, active: true });
          State.log(s.session.user.username, 'user_create', `${username} // ${role}`);
          State.save(); UI.renderAll();
          byId('userName').value = '';
          byId('userPass').value = '';
        };
      }

      // Passwort ändern (eigener Nutzer)
      const btnPwd = byId('btnChangePass');
      if (btnPwd) {
        btnPwd.onclick = async () => {
          const np = byId('newPass').value.trim();
          if (!np) return;
          const s = State.get();
          const u = s.users.find(x => x.username === s.session.user.username);
          u.passHash = await sha256Hex(np);
          State.save();
          byId('newPass').value = '';
        };
      }

      // Reset (nur Admin)
      const btnReset = byId('btnReset');
      if (btnReset) {
        btnReset.style.display = Auth.isAdmin() ? 'inline-block' : 'none';
        btnReset.onclick = () => {
          if (!Auth.isAdmin()) return alert('Nur Admin');
          if (!confirm('Zurücksetzen?')) return;
          localStorage.removeItem(LS_KEY);
          State.load(); State.save(); UI.renderAll();
        };
      }

      // Tabs (+ Admin-Guard)
      document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
          const key = t.dataset.tab;
          if ((key === 'users' || key === 'settings') && !Auth.isAdmin()) return;
          document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
          t.classList.add('active');
          ['dashboard','deps','requests','users','settings'].forEach(k => {
            const el = byId('tab-'+k);
            if (el) el.style.display = (k === key) ? 'block' : 'none';
          });
        };
      });
    }

    // ---- Exposed inline handlers (für Buttons in Tabellen) ----
    function deleteDep(id){
      if(!(Auth.isMinister()||Auth.isAdmin())) return;
      const s=State.get();
      const dep=s.departments.find(d=>d.id===id);
      if(dep?.budget>0) return alert('Budget zuerst auf 0');
      s.departments=s.departments.filter(d=>d.id!==id);
      State.log(s.session.user.username,'dep_delete',dep?dep.code:'');
      State.save(); UI.renderAll();
    }
    function editDepPrompt(id){
      if(!(Auth.isMinister()||Auth.isAdmin())) return;
      const s=State.get();
      const dep=s.departments.find(d=>d.id===id);
      const name=prompt('Neuer Name',dep.name);
      if(name){
        dep.name=name.trim();
        State.save(); UI.renderAll();
        State.log(s.session.user.username,'dep_rename',dep.code+'->'+name);
      }
    }
    function allocPrompt(id){
      if(!(Auth.isMinister()||Auth.isAdmin())) return;
      const s=State.get();
      const dep=s.departments.find(d=>d.id===id);
      const amtStr=prompt('Betrag (Credits), verfügbar: '+numDE(Compute.available()), '10000');
      if(!amtStr) return;
      const amt=parseFloat(amtStr.replace(',','.'));
      if(!(amt>0)) return;
      if(amt>Compute.available()) return alert('Zu wenig Fond');
      dep.budget+=amt;
      State.log(s.session.user.username,'alloc',dep.code+' +'+amt);
      State.save(); UI.renderAll();
    }
    function approveReq(id){
      if(!(Auth.isMinister()||Auth.isAdmin())) return;
      const s=State.get();
      const r=s.requests.find(x=>x.id===id);
      if(!r||r.status!=='pending') return;
      if(r.amount>Compute.available()) return alert('Zu wenig Fond');
      const dep=s.departments.find(d=>d.id===r.deptId);
      dep.budget+=r.amount;
      r.status='approved';
      r.decidedBy=s.session.user.username;
      r.decidedAt=now();
      State.log(s.session.user.username,'req_approve',r.title+' '+r.amount);
      State.save(); UI.renderAll();
    }
    function rejectReq(id){
      if(!(Auth.isMinister()||Auth.isAdmin())) return;
      const s=State.get();
      const r=s.requests.find(x=>x.id===id);
      if(!r||r.status!=='pending') return;
      r.status='rejected';
      r.decidedBy=s.session.user.username;
      r.decidedAt=now();
      State.log(s.session.user.username,'req_reject',r.title);
      State.save(); UI.renderAll();
    }
    function deleteReq(id){
      if(!(Auth.isMinister()||Auth.isAdmin())) return;
      const s=State.get();
      s.requests=s.requests.filter(x=>x.id!==id);
      State.log(s.session.user.username,'req_delete',id);
      State.save(); UI.renderAll();
    }
    function editUserPrompt(username){
      if(!Auth.isAdmin()) return;
      const s=State.get();
      const u=s.users.find(x=>x.username===username);
      if(!u) return;
      const newRole=prompt('Rolle',u.role);
      if(newRole) u.role=newRole.trim();
      const newPass=prompt('Neues Passwort (leer=skip)','');
      if(newPass) sha256Hex(newPass).then(h=>{ u.passHash=h; State.save(); UI.renderAll(); });
      else { State.save(); UI.renderAll(); }
      State.log(s.session.user.username,'user_edit',username);
    }
    function toggleUser(username){
      if(!Auth.isAdmin()) return;
      const s=State.get();
      const u=s.users.find(x=>x.username===username);
      if(!u) return;
      u.active=!u.active;
      State.save(); UI.renderAll();
      State.log(s.session.user.username,'user_toggle',username+' -> '+(u.active?'aktiv':'deaktiviert'));
    }
    function deleteUser(username){
      if(!Auth.isAdmin()) return;
      const s=State.get();
      if(s.session.user?.username===username) return alert('Aktiv eingeloggten Nutzer nicht löschen');
      s.users=s.users.filter(u=>u.username!==username);
      State.save(); UI.renderAll();
      State.log(s.session.user.username,'user_delete',username);
    }

    return { bind, deleteDep, editDepPrompt, allocPrompt, approveReq, rejectReq, deleteReq, editUserPrompt, toggleUser, deleteUser };
  })();

  // Für Inline-Handler und alte Aufrufe verfügbar machen
  window.Actions = Actions;
  ['deleteDep','editDepPrompt','allocPrompt','approveReq','rejectReq','deleteReq','editUserPrompt','toggleUser','deleteUser']
    .forEach(fn => window[fn] = (...a) => Actions[fn](...a));

  // ===== BLOCK: BOOT =====
  (function Boot(){
    const loader = byId('loader');
    const wrap   = byId('rootWrap');

    function finish(){
      if (loader) loader.style.display = 'none';
      if (wrap)   wrap.style.opacity   = 1;
    }

    try { State.load(); } catch(e){ console.error('State load error:', e); }

    window.addEventListener('load', () => {
      try {
        Actions.bind?.();
        UI.renderAll?.();
      } catch (e) {
        console.error('Init error:', e);
      } finally {
        finish(); // Loader sicher aus
      }
    });

    // Failsafe
    setTimeout(finish, 3000);
  })();
  </script>
</body>
</html>
